<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³“è²¡WBank - {{user}} é é¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/wbank/scan.css">
    <link rel="stylesheet" href="/static/wbank/modals.css">
    <link rel="stylesheet" href="/static/wbank/authpayment.css">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f4f8; /* æ·ºèƒŒæ™¯è‰² */
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            width: 100%;
            background-color: #003366; /* æ·±è—è‰² */
            color: white;
            padding: 15px 0;
            text-align: center;
            font-size: 24px;
        }
        #container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #007bff; /* æŒ‰éˆ•é¡è‰² */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            text-align: center;
        }
        .button:hover {
            background-color: #0056b3; /* æ‡¸åœé¡è‰² */
        }
        .flashes {
            list-style-type: none;
            padding: 0;
            margin: 20px 0;
        }
        .flashes li {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .flashes li.success {
            background-color: #d4edda;
            color: #155724;
        }
        .flashes li.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .flashes li.info {
            background-color: #cce5ff;
            color: #004085;
        }
        .input-group {
            margin: 15px 0;
        }
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        input[type="text"]:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }
        .nav {
            display: flex;
            justify-content: space-around;
            background-color: #ffffff;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            text-align: center;
            flex: 1;
            cursor: pointer;
            color: #007bff;
        }
        .nav-item:hover {
            color: #0056b3;
        }
        /* é è¨­éš±è—çš„å…ƒç´  */
        .page {
            display: none;
        }
        .active {
            display: block;
        }

        /* äº¤æ˜“åŠŸèƒ½å€çš„æ¨£å¼ */
        #fuc1 {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        #fuc1 p {
            text-align: center;
            margin: 10px;
            width: 30%; /* æ§åˆ¶æ¯å€‹åŠŸèƒ½çš„å¯¬åº¦ */
        }
        #fuc1 img {
            display: block;
            margin: 0 auto;
        }
        .my-card {
           text-align: center;
           background-color: rgb(0,0,255);
           color: rgb(255,255,255);
        }
        .triangle {
          width: 0;
          height: 0;
          display: inline-block;
       }
       .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    .switch input {
        display: none; /* éš±è—åŸå§‹checkbox */
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        border-radius: 34px;
        transition: background-color 0.4s; /* èƒŒæ™¯é¡è‰²è®ŠåŒ– */
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.4s ease; /* å‹•ç•«æ•ˆæœ */
    }
    /* ç•¶ input è¢«é¸ä¸­æ™‚çš„æ¨£å¼ */
    .switch input:checked + .slider {
        background-color: #2196F3;
    }
    .switch input:checked + .slider:before {
        transform: translateX(26px); /* æ»‘å‹•æ•ˆæœ */
    }
    #result {
        margin-top: 20px;
        display: none; /* åˆå§‹éš±è— */
    }
    #qrCode {
        margin-top: 10px;
        /* æ­¤è™•å¯æ ¹æ“šéœ€æ±‚è¨­ç½® QR ç¢¼çš„æ¨£å¼ */
    }
    .modal-backdrop {
        display: none;
    }
    #tradeHintText {
      display: none;
      background-color: #cce5ff;
      color: #004085;
    }
     /* Chat Modal èƒŒæ™¯ */
        .chat-modal {
            display: none; /* é»˜èªéš±è— */
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 1000; /* å±¤ç´š */
            left: 0;
            top: 0;
            width: 100%; /* å¯¬åº¦100% */
            height: 100%; /* é«˜åº¦100% */
            overflow: auto; /* æ»¾å‹• */
            background-color: rgba(0, 0, 0, 0.7); /* èƒŒæ™¯é¡è‰² */
        }

        /* Chat Modal å…§å®¹ */
        .chat-modal-content {
            background-color: #fefefe; /* èƒŒæ™¯è‰² */
            margin: 10% auto; /* ä¸Šé‚Šè· */
            padding: 20px; /* å…§é‚Šè· */
            border: 1px solid #ccc; /* é‚Šæ¡† */
            width: 80%; /* å¯¬åº¦ */
            max-width: 500px; /* æœ€å¤§å¯¬åº¦ */
            border-radius: 15px; /* åœ“è§’ */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); /* é™°å½±æ•ˆæœ */
        }

        /* Chaté—œé–‰æŒ‰éˆ• */
        .chat-close {
            color: #d9534f; /* é¡è‰² */
            float: right; /* å³å´ */
            font-size: 30px; /* å­—é«”å¤§å° */
            font-weight: bold; /* ç²—é«” */
        }

        .chat-close:hover,
        .chat-close:focus {
            color: #c9302c; /* æ‡¸åœæ•ˆæœ */
            text-decoration: none; /* å»é™¤ä¸‹åŠƒç·š */
            cursor: pointer; /* é¼ æ¨™æ¨£å¼ */
        }

        /* åœ“å½¢æŒ‰éˆ•æ¨£å¼ */
        #open-chat-modal {
            position: fixed; /* å›ºå®šå®šä½ */
            bottom: 20px; /* è·é›¢åº•éƒ¨20px */
            right: 20px; /* è·é›¢å³å´20px */
            width: 60px; /* å¯¬åº¦ */
            height: 60px; /* é«˜åº¦ */
            border-radius: 50%; /* åœ“å½¢ */
            background-color: #7289da; /* èƒŒæ™¯é¡è‰² */
            color: white; /* æ–‡å­—é¡è‰² */
            border: none; /* å»é™¤é‚Šæ¡† */
            font-size: 24px; /* å­—é«”å¤§å° */
            cursor: pointer; /* é¼ æ¨™æ¨£å¼ */
            display: flex; /* å…§è¯å½ˆæ€§ç›’æ¨¡å‹ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* é™°å½±æ•ˆæœ */
        }

        #open-chat-modal:hover {
            background-color: #5b6eae; /* æ‡¸åœé¡è‰² */
        }

        /* è‡ªå®šç¾©æ–‡å­—æ¨£å¼ */
        .chat-modal-content h2 {
            font-size: 1.5rem; /* æ¨™é¡Œå­—é«”å¤§å° */
            color: #333; /* æ¨™é¡Œé¡è‰² */
            margin: 0 0 10px; /* é‚Šè· */
        }

        .chat-modal-content p {
            font-size: 1rem; /* æ–‡å­—å­—é«”å¤§å° */
            color: #555; /* æ–‡å­—é¡è‰² */
            line-height: 1.5; /* è¡Œé«˜ */
        }
        .chat-area {
            display: block; /* åˆå§‹é¡¯ç¤ºèŠå¤©å€åŸŸ */
        }
        .chat-messages {
            border: 1px solid #ccc; 
            height: 200px; 
            overflow-y: auto; 
            margin-bottom: 10px; 
            padding: 10px; 
        }
        .message {
            margin: 5px 0;
        }
        .sent {
            text-align: right;
            color: blue;
        }
        .received {
            text-align: left;
            color: green;
        }
    </style>
</head>
<body>

    <!-- é€šçŸ¥å€åŸŸ -->
    <div id="paymentNotification" class="custom-payment-notification">
        <p id="paymentDetails">ç­‰å¾…ä»˜æ¬¾æ†‘æ“š...</p>
        <div class="custom-slider-container">
            <br>
            <br>
            <input type="range" id="authorizationSlider" min="0" max="100" value="0" class="custom-slider">
        </div>
    </div>
    
    <!-- Chat Modal -->
    <button id="open-chat-modal" class="send-button">ğŸ—¨ï¸</button>

    <div id="chatModal" class="chat-modal">
        <div class="chat-modal-content">
            <span class="chat-close">&times;</span>
            <h2>æ­¡è¿ä½¿ç”¨ç·šä¸Šå®¢æœ</h2>
            <p>åœ¨å°è©±æ™‚ï¼Œè«‹æ³¨æ„è¨€è©</p>
            <div id="chat-container">
                <div class="chat-area" style="display: none;">
                    <button id="exit-button" class="send-button">é›¢é–‹é »é“</button>
                    <div class="chat-messages" id="chat-messages"></div>
                    <input type="text" id="message-input" placeholder="è¼¸å…¥è¨Šæ¯...">
                    <input type="file" id="image-upload" accept="image/*">
                    <button id="send-button" class="send-button">å‚³é€è¨Šæ¯</button>
                </div>
            </div>
            <br />
            <p style="color: gray;">æœ¬æ¬¡chatæ‡‰ç”¨ä½¿ç”¨wchat-api</p>
        </div>
    </div>
    
    <header>WBank - æ•¸å­—éŠ€è¡Œ</header>

    <div id="container">

        <div id="home" class="page active">
            <div class="card">
                <h2>ä½ å¥½ {{user}}</h2>
                <p>ä½ çš„ç¸½è³‡ç”¢: WTC${{balance}}</p>
                <button class="button" onclick="moneyScreen()">æ›´å¤šè²¨å¹£è³‡è¨Š</button>
                <button class="button" onclick="window.location.reload()">Reload</button>
            </div>
        </div>

        <div id="tradeChart" class="page">
            <div class="card">
                <span id="tradeHintText"></span>
                <br>
                <h2>æŠ•è³‡</h2>
                <h3>å¯æŠ•è³‡çš„è³‡ç”¢é …ç›®</h3>
    <table class="table table-striped" id="availableStocks">
        <thead>
            <tr>
                <th>ç†è²¡é …ç›®</th>
                <th>ç•¶å‰åƒ¹æ ¼</th>
                <th>é ä¼°å‡é™</th>
                <th>ç™¾åˆ†æ¯”%</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>WBankå…§éŠ€è‚¡</td>
                <td class="price"></td>
                <td class="triangle" style="border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid gray;"></td>
                <td class="percentage">0%</td>
                <td><button class="btn btn-primary">è²·å…¥</button></td>
            </tr>
            <tr>
                <td>æ³“åœ‹ç¶œåˆæŒ‡æ•¸</td>
                <td class="price"></td>
                <td class="triangle" style="border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid gray;"></td>
                <td class="percentage">0%</td>
                <td><button class="btn btn-primary">è²·å…¥</button></td>
            </tr>
            <tr>
                <td>ç¶“ç™¼é›†åœ˜</td>
                <td class="price"></td>
                <td class="triangle" style="border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid gray;"></td>
                <td class="percentage">0%</td>
                <td><button class="btn btn-primary">è²·å…¥</button></td>
            </tr>
            <tr>
                <td>WTC/HKD</td>
                <td class="price"></td>
                <td class="triangle" style="border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid gray;"></td>
                <td class="percentage">0%</td>
                <td><button class="btn btn-primary">è²·å…¥</button></td>
            </tr>
            <tr>
                <td>BEn-stock</td>
                <td class="price"></td>
                <td class="triangle" style="border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid gray;"></td>
                <td class="percentage">0%</td>
                <td><button class="btn btn-primary">è²·å…¥</button></td>
            </tr>
        </tbody>
    </table>

    <h3 class="mt-5">ç›®å‰æŒå€‰</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>è³‡ç”¢åç¨±</th>
                <th>åƒ¹æ ¼</th>
                <th>æ•¸é‡</th>
                <th>ç¸½è¨ˆï¼ˆè²·åƒ¹)</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="portfolio"></tbody>
    </table>
    <br>
        <label>é»‘æš—èƒŒæ™¯é¡è‰²: </label>
        <label class="switch">
        <input type="checkbox" id="colorSwitch" onchange="changeBGColor()">
        <span class="slider"></span>
        </label>
            </div>
        </div>

        <div id="trade" class="page">
            <div class="card">
                <h2>åŠŸèƒ½å€</h2>
                <div id="fuc1">
                    <p id="pp" class="paypal"><img src="{{ url_for('static',filename='IMG_9742.jpeg') }}" alt="paypal" width="30" height="35"><br>ç”¨Paypalè²·å…¥</p>
                    <p id="so" class="spend-out"><img src="{{ url_for('static',filename='IMG_9744.png') }}" alt="spend-out" width="30" height="35"><br>æŸ¥çœ‹éŒ¢åŒ…åœ°å€</p>
                    <p id="vc" class='vc'>ğŸ’³æ³“é€šå¡</p>
                </div>
                <br>
                <div id="fuc1">
                    <p id="record" class="record"><img src="{{ url_for('static',filename='IMG_2975.png') }}" alt="record" width="30" height="35"><br>æ”¶æ¬¾æ˜ç´°</p>
                    <p id="loan" class="loan"><img src="{{ url_for('static',filename='IMG_9992.jpeg') }}" alt="get-loan" width="30" height="35"><br>å€Ÿå¹£ï¼ˆè²¸æ¬¾ï¼‰</p>
                    <p id="ap" class="ap"><img src="{{ url_for('static',filename='IMG_0152.png') }}" alt="nfc-pay" width="30" height="35"><br>å…¥é‡‘</p>
                    <p id="np-pay" class="cast-out"><img src="{{ url_for('static',filename='IMG_9743.png') }}" alt="np-pay" width="30" height="35"><br>ç¹³è²»å¸³å–®</p>
                </div>
            </div>
        </div>
        <!-- QR screen-->
       <div id="qrModal" class="model">
    <div class="model-content">
        <span class="close" onclick="closeQRCode()">&times;</span>
        <h3>éŒ¢åŒ…åœ°å€ QR ç¢¼</h3>
        <div id="qrCode">
            <!-- æ­¤è™•æ”¾ç½®ç”Ÿæˆçš„ QR ç¢¼ -->
            <img src="data:image/svg+xml;base64,{{ img }}" alt="QR Code" width="250" height="250"> <!-- æ›¿æ›ç‚ºå¯¦éš›çš„ QR ç¢¼ -->
        </div>
    </div>
</div>
        <!-- End qr screen-->
        <!-- è™›æ“¬å¡ -->
        <div id="vcardModal" class="model">
    <div class="model-content">
        <span class="close" onclick="document.getElementById('vcardModal').style.display='none';">&times;</span>
        <h3>æ³“é€šå¡</h3>
        <div id="vcard">
            <label>å¡è™Ÿ: </label>{{ hash_card_number }}
            <br>
            <p style="color: gray;">å¯†ç¢¼æ˜¯ä½ çš„å¯†ç¢¼</p>
        </div>
    </div>
</div>
        <!-- End of virual-card screen -->
        <!-- å…¥é‡‘ -->
        <div id="apModal" class="model">
    <div class="model-content">
        <span class="close" onclick="document.getElementById('apModal').style.display='none';">&times;</span>
        <h3>å…¥é‡‘ï¼ˆè¦è‡ªå·±å…¥é‡‘)</h3>
        <div id="vcard">
            <label>è¼¸å…¥é‡‘é¡ï¼š(WTC$)</label>
            <input type="number" id="ap-amount">
            <br>
            <label>é¸æ“‡æ”¯ä»˜æ–¹å¼:</label>
            <select id="ap-pm" onchange="apPmText()">
                <option value="default">å®¢æœå«æˆ‘é¸é€™å€‹</option>
                <option value="alipay-hk">æ”¯ä»˜å¯¶-Alipay</option>
                <option value="bank-hk">è½‰æ•¸å¿«-FPS(åªé™é¦™æ¸¯)</option>
                <option value="line-pay">ç·šä¹‹ä»˜-LinePay</option>
             </select>
             <br>
            <textarea id="pm-ap-text" height="70px" readonly>
                é™¤éè·å“¡å«ä½ ç”¨é€™å€‹ï¼Œå¦å‰‡ä½ ä¸æœƒæœ‰æ”¶æ¬¾å¸³è™Ÿçš„ã€‚
             </textarea>
            <br>
            <p style="color: gray;">ä»˜æ¬¾å¾Œï¼Œä¿ç•™æˆªåœ–ï¼Œç™¼é€è‡³å®¢æœéƒ¨ï¼šcs@wtechhk.com æˆ– åŠ å…¥discordè¯ç¹«è·å“¡ã€‚</p>
        </div>
    </div>
</div>
        <!-- End of cash-in -->
        <!-- äº¤è²»ç”¨ -->
        <div id="needPayModal" class="model">
    <div class="model-content">
        <span class="close" onclick="document.getElementById('needPayModal').style.display='none';">&times;</span>
        <h3>ç¹³è²»</h3>
        <div id="wnp">
            <label>WBankç”¨æˆ¶å: </label>
            <input type="text" value="{{user}}">
            <br>
            <label>ç¹³è²»ç›®çš„: </label>
            <select id="npSelector">
                <option value="def">--è«‹é¸æ“‡ç¹³è²»ç›®çš„--</option>
                <option value="pm-tax">æ³“åœ‹ç¨…å‹™å±€</option>
                <option value="pm-nsgov">æ³“åœ‹å—çœæ”¿åºœ</option>
            </select>
            <br>
            <label>æ‡‰ä»˜é‡‘é¡: </label>
            <input type="number" id="pmn-amount" min="100">
            <br>
            <button class="button" onclick="paymentNeed()">ç¢ºèªäº¤æ˜“</button>
            <br>
            <p style="color: gray;">è«‹çœ‹æ¸…æ¥šå¸³å–®æ‰ä»˜æ¬¾</p>
        </div>
    </div>
</div>
        <!-- End screen -->
        <div id="myPage" class="page">
            <div class="card">
                <h2>æˆ‘çš„</h2>
                <div class="my-card">
                <p>ç”¨æˆ¶å: {{user}}</p>
                <p>å¸³æˆ¶è™Ÿç¢¼: {{acc_number}}</p>
                <p>é¤˜é¡: WTC$<span id="balance">{{balance}}</span></p>
                <br>
                </div>
                <br>
                <h3>ç”¨æˆ¶è¨­ç½®å€</h3>
                <!-- button class="button" onclick="scan()">æƒæQR-code</button> -->
                <button class="button" data-toggle="modal" data-target="#settingModal">è¨­å®š</button>
                <br>
                <br>
                <button class="button" onclick="wbankLogout()">ç™»å‡º</button>
            </div>
        </div>
        <!-- Confirm Screen -->
        <div id="allConfirmModal" class="modal">
            <div class="model-content">
              <span class="close" onclick="document.getElementById('allConfirmModal').style.display='none';">&times;</span>
              <br>
              <h2>ç¢ºèªæ“ä½œ</h2>
              <br>
              <span id="Confirm-detail"></span>
              <br>
              <textarea readonly></textarea>
            </div>
        </div>
        <!-- End Screen -->
        <!-- New Screen -->
        <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResult()">&times;</span>
            <div id="result"></div> <!-- é¡¯ç¤ºæƒæçµæœ -->
        </div>
    </div>
        <!-- End sdreen -->
        <div id="moneyScreen" class="card" style="display:none;">
            <h3>è²¨å¹£è³‡è¨Š</h3>
            <label>æ¸¯å¹£HKD: {{HK_Value}}</label><br>
            <label>æ–°å°å¹£NTD: {{tw_value}}</label><br>
            <label>ç¾é‡‘USD: {{US_value}}</label><br>
            <button class="button" onclick="closeMoneyScreen()">é—œé–‰</button>
        </div>
        <div class="modal fade" id="settingModal" tabindex="-1" role="dialog" aria-labelledby="settingModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingModalLabel">è¨­å®š</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3>è¨­å®š</h3>
                    <label>å¹³å°åç¨±ï¼š WBank -- æ³“è²¡éŠ€è¡Œ</label><br>
                    <label>ç‰ˆæœ¬ï¼š ~v2ï¼ˆæŒ‰æ³“å¹£wcoinsç‰ˆæœ¬çµç®—ï¼‰</label><br>
                    <label>è¨»éŠ·å¸³è™Ÿï¼š</label>
                    <button class="button" onclick="removeAcc()">è¨»éŠ·</button>
                    <label>é–‹å•Ÿäº¤æ˜“åŠŸèƒ½ï¼š</label>
                    <label class="switch">
                    <input type="checkbox" id="toggleSwitch" {% if openpay %}checked{% endif %} onchange="paymentChange()">
                    <span class="slider"></span>
                    </label> 
                    <label>è¨­ç½®äº¤æ˜“é™é¡ (WTC$):</label>
                    <input type="number" id="setAmountOfTrade" value="{{ setAmount }}">
                    <br>
                    <label>è¨­ç½®å¤–éƒ¨éŠ€è¡Œå¸³æˆ¶:</label>
                    <input type="text" id="accnumberno">
                    <br>
                    <label>ç§»é™¤é™é¡ : </label>
                    <button class="button" onclick="removeAmount()">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
            {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}
        {% endwith %}

    </div>

    <div class="nav">
        <div class="nav-item" onclick="showPage('home')">é¦–é </div>
        <div class="nav-item" onclick="showPage('tradeChart')">æŠ•è³‡</div>
        <div class="nav-item" onclick="showPage('trade')">è½‰å¸³åŠåŠŸèƒ½</div>
        <div class="nav-item" onclick="showPage('myPage')">æˆ‘çš„</div>
    </div>

    <script>
        var socket = io();
        var bot_status = 'no';
        var accnumber = "{{ acc_number }}";
        var balance = parseFloat("{{ balance }}");
        var user = "{{ user }}";
        const paymentDetails = document.getElementById('paymentDetails');
        const slider = document.getElementById('authorizationSlider');
        const notification = document.getElementById('paymentNotification');
        let setAmountOfTrade = document.getElementById('setAmountOfTrade');
        setAmountOfTrade.addEventListener('keypress',(event) => {
          if (event.key === "Enter") {
           fetch("/wbank/v1/setamount",{headers:{user:"{{user}}",amount:setAmountOfTrade.value}})
             .then (res=>res.text())
             .then (data=>alert(data));
        }
      });
      const accnumberElement = document.getElementById("accnumberno");
      accnumberElement.addEventListener('keypress', (event) => {
        if (event.key === "Enter") {
          const accnumberno = accnumberElement.value;
          const expires = new Date(Date.now() + 86400e3).toUTCString(); // 1 å¤©å¾ŒéæœŸ
          document.cookie = `accnumber=${encodeURIComponent(accnumberno)}; expires=${expires}; path=/`;
          alert("è¨­ç½®æˆåŠŸ");
        }
      });
    function getCookie(cname) {
       const value = `; ${document.cookie}`;
       const parts = value.split(`; ${cname}=`);
       if (parts.length === 2) return parts.pop().split(';').shift();
    }
    accnumberElement.value = getCookie("accnumber");
    // é¡¯ç¤ºæŒ‡å®šé é¢
    function showPage(pageId) {
        // éš±è—æ‰€æœ‰é é¢
        const pages = document.querySelectorAll('.page');
        pages.forEach(page => {
            page.classList.remove('active');
        });

        // é¡¯ç¤ºé¸å®šçš„é é¢
        document.getElementById(pageId).classList.add('active');
    }
     //å–æ¶ˆæˆæ¬ŠPayAuth
    function removePayAuth() {
            slider.disabled = true;
            fetch(`/wbank/remove/order?user=${user}`)
             .then(res=>res.text())
             .then(msg=> {
                notification.style.bottom = '-200px'; // å‹•ç•«éš±è—
                setTimeout(() => {
                  notification.style.display = 'none'; // éš±è—é€šçŸ¥
                }, 500); // ç­‰å¾…å‹•ç•«çµæŸå¾Œå†éš±è—
                slider.value = 0;
                });
        }
        function handlePaymentAuth(username, reviewer, amount) {
    // æ ¼å¼åŒ–ä»˜æ¬¾æ†‘æ“š
    paymentDetails.innerHTML = `
        <strong>è½‰å¸³æ–¹ï¼š</strong> ${username} <br>
        <strong>æ”¶æ¬¾æ–¹ï¼š</strong> ${reviewer} <br>
        <strong>é‡‘é¡ï¼š</strong> ${amount} 
    `;

    // é¡¯ç¤ºé€šçŸ¥ä¸¦å•Ÿå‹•ç•«é¢
    notification.style.display = 'block'; // é¡¯ç¤ºé€šçŸ¥
    //notification.style.bottom = '0';
    setTimeout(() => {
        notification.style.bottom = '0'; // å‹•ç•«é¡¯ç¤º
    }, 10); // ç­‰å¾…é¡¯ç¤ºå¾Œå†é–‹å§‹å‹•ç•«
    // é‡ç½®æ»‘å‹•æ¡¿
    slider.value = 0;
    setTimeout(()=>removePayAuth(),9000);
    // æ›´æ–°æ»‘å‹•æ¡¿é€²åº¦
    slider.addEventListener('input', function() {
        if (slider.disabled) {
        slider.value = 0;
        notification.style.display = 'none'; // éš±è—é€šçŸ¥
        } else {
        const value = this.value;
        if (value > 0) {
            this.classList.add('active'); // æ·»åŠ é¡ä»¥æ”¹è®Šæ»‘å¡Šé¡è‰²
        }
        if (value >= 100) {
            // ç•¶æ»‘å‹•åˆ°100%æ™‚ï¼Œè§¸ç™¼è½‰å¸³
            handleTransfer(username, reviewer, amount);
        }
        }
    });
}
        function handleTransfer(username, reviewer, amount) {
            fetch ("/wbank/hash/transfer",{headers: {user:username,reviewer:reviewer,amount:amount}})
              .then (res => res.json())
              .then (msg => {
                 if (msg.success) {
                    fetch(`/wbank/remove/order?user=${username}`)
                     .then(res=>res.text())
                     .then(msg=>console.log(msg));
                    alert("ä»˜æ¬¾æˆåŠŸ");
                    window.location.reload();
                 } else {
                    alert(msg);
                    fetch(`/wbank/remove/order?user=${username}`)
                     .then(res=>res.text())
                     .then(msg=>console.log(msg));
                    window.location.reload();
                 }
              })
              .catch (err => alert(err));

            // éš±è—é€šçŸ¥ä¸¦å•Ÿå‹•ç•«é¢
            notification.style.bottom = '-200px'; // å‹•ç•«éš±è—
            setTimeout(() => {
                notification.style.display = 'none'; // éš±è—é€šçŸ¥
            }, 500); // ç­‰å¾…å‹•ç•«çµæŸå¾Œå†éš±è—
            slider.value = 0; // é‡ç½®æ»‘å‹•æ¡¿
        }
        setInterval(()=>{
          fetch (`/wbank/checkPaymentStatus?user=${user}`)
            .then (res=>res.json())
            .then (data=>{
                if (data.paymentAuth) {
                    return handlePaymentAuth(data.paymentAuth.username, data.paymentAuth.reviewer, data.paymentAuth.amount);
                }
             })
            .catch (err=>console.error(err));
        },1000);
        function wbankLogout() {
           window.location.href="/wbank/logout";
        }
        function removeAmount() {
            fetch ("/wbank/removeAmount",{headers:{"user":"{{user}}"}})
              .then (res=>res.text())
              .then (msg=>alert(msg));
        }
        
        const transfer = () => {
            window.location.href = "/wbank/transfer";
        };

        const buy = () => {
            let amount = prompt("How much do you wanna buy in?");
            let value = amount * 3.5;
            window.location.href = "/wbank/v1/paypal?user=" + user + "&amount=" + value;
        };

        const sell = () => {
            window.location.href = "/wbank/sellCoins?user=" + user;
        };

        const moneyScreen = () => {
            document.getElementById("moneyScreen").style.display = "block";
        };

        const closeMoneyScreen = () => {
            document.getElementById("moneyScreen").style.display = "none";
        };

        const openSettingScreen = () => {
      document.getElementById("settingScreen").style.display = "block";
    };
        const closeScreenScreen = () => {
      document.getElementById("settingScreen").style.display = "none";
    };
    const removeAcc = () => {
      socket.emit("removeAccount",{
         username: "{{user}}"
      });
     window.location.href="/wbank";
    };
    const paymentNeed = () => {
      // pmn = Payment-Need
      let pmnAmount = document.getElementById("pmn-amount").value;
      let pmnSelector = document.getElementById("npSelector");
      let pmnReceiver = "wbank";
      if (pmnAmount == "" || pmnAmount == null) return;
      if (pmnSelector.value == "pm-tax") pmnReceiver="w.gov/tax";
      else if (pmnSelector.value == "pm-nsgov") pmnReceiver="w.gov/nan.sheng";
      else {
        alert("æ‰¾ä¸åˆ°æ”¶æ¬¾å–®ä½");
        return;
      }
      if (pmnSelector.value == "def") alert("è«‹é¸æ“‡ç¹³ä»˜å¸³å–®å–®ä½");
      let confirmPay = confirm(`è«‹ç¢ºèªæ˜¯å¦äº¤æ˜“å¸³å–®æ­£ç¢ºï¼š \n\n ä»˜æ¬¾äººï¼šä½ çš„è³¬æˆ¶ \n æ”¶æ¬¾å–®ä½ï¼š${pmnReceiver} \n æ‡‰ç¹³é‡‘é¡: WTC$${pmnAmount} \n\n âš ï¸è«‹æ³¨æ„ï¼šæŒ‰ä¸‹ç¢ºèªæˆ–okä»£è¡¨ä½ åŒæ„ç›¸é—œæ¢æ¬¾ï¼Œè«‹çœ‹æ¸…æ¥šã€‚å¦‚æœ‰ç–å¿½é€ æˆè³¬æˆ¶æ‰£æ¬¾ï¼Œwbankä¸€æ¦‚ä¸è² è²¬ã€‚`);
      if (confirmPay == false) return;
      let pmnRequestFormat = {
        cardNumber: "{{ hash_card_number }}",
        password: "{{ session['pw'] }}",
        accessKey: "****",
        reviewer: pmnReceiver,
        amount: pmnAmount
      };
      let pmnRequestHeaders = {
        "Content-Type": "application/json"
      };
      fetch ("/wbank/card/action", { method: "PATCH", headers: pmnRequestHeaders, body: JSON.stringify(pmnRequestFormat) })
       .then (res=>res.json())
       .then (data => {
         if (data.code == 200) {
            alert("ä»˜æ¬¾æˆåŠŸ");
            pmnAmount = '';
            pmnSelector.value = 'def';
            document.getElementById('needPayModal').style.display = 'none';
         } else {
            if (data.error == "The card has insufficient balance") alert("ä»˜æ¬¾å¤±æ•—: æ‚¨çš„æ³“é€šå¡ä¿¡ç”¨é¡å·²æ»¿ï¼Œè«‹é‚„æ¸…å†ä»˜æ¬¾");
            pmnAmount = '';
            pmnSelector.value = 'def';
            document.getElementById('needPayModal').style.display = 'none';
        }
       })
       .catch(err => alert("WBankCardAPIéŒ¯èª¤: "+err.message));
    };
    //å¯ä»¥æ§åˆ¶äº¤æ˜“
    function paymentChange() {
            const toggleSwitch = document.getElementById('toggleSwitch');
            // åœ¨é€™è£¡å¯ä»¥æ ¹æ“šé–‹é—œç‹€æ…‹ç™¼é€è«‹æ±‚
            if (toggleSwitch.checked) {
                fetch("/wbank/v1/openpay", {
                    headers: {
                        user: "{{ user }}"
                    }
                })
                .then(res => res.text())
                .then(data => alert(data));
            } else {
                fetch("/wbank/v1/closepay", {
                    headers: {
                        user: "{{ user }}"
                    }
                })
                .then(res => res.text())
                .then(data => alert(data));
            }
       }
        const scan = () => {
            fetch ("/wbank/scan?user=" + user)
                .then (res => res.text())
                .then (data => {
                    const modal = document.getElementById('resultModal');
                    modal.classList.add('show'); 
                });
        };
        const closeResult = () => {
        const modal = document.getElementById('resultModal');
        modal.classList.remove('show'); // éš±è—æ¨¡æ…‹æ¡†
        // ç­‰å¾…å‹•ç•«çµæŸå¾Œå†éš±è—æ¨¡æ…‹æ¡†
        setTimeout(() => {
            modal.style.display = 'none';
        }, 500); // å‹•ç•«æ™‚é•·
    };
        document.getElementById("record").addEventListener("click",() => {
        window.location.href="/wbank/recordPage?user=" + "{{ user }}";
      });
      document.getElementById("loan").addEventListener("click",() => {
        window.location.href="/wbank/loan?user=" + accnumber;
      });
      document.getElementById("np-pay").addEventListener("click",() => {
        document.getElementById('needPayModal').style.display = 'flex'; 
      });
      document.getElementById("so").addEventListener("click",() => {
        //window.location.href="/wbank/sellCoins?user=" + "{{ user }}";
        document.getElementById('qrModal').style.display = 'flex'; 
      });
      document.getElementById("vc").addEventListener("click",() => {
        document.getElementById('vcardModal').style.display = 'flex'; 
      });
     // Cash-in
     document.getElementById("ap").addEventListener("click",()=> {
       document.getElementById("apModal").style.display = "flex";
      });
    const apPmText = () => {
     let apAmount = document.getElementById("ap-amount");
     if (!apAmount || apAmount == null) return;
     if (apAmount.value == null) return;
     let apPmText = document.getElementById("pm-ap-text");
     let apPm = document.getElementById("ap-pm");
     if (apPm.value == "default") {
        apPmText.value = `
          é™¤éè·å“¡å«ä½ ç”¨é€™å€‹ï¼Œå¦å‰‡ä½ ä¸æœƒæœ‰æ”¶æ¬¾å¸³è™Ÿçš„ã€‚
        `;
     } else if (apPm.value == "alipay-hk") {
        if (parseFloat(apAmount.value) < 100) {
            alert("ä½ çš„é‡‘é¡éå°");
            apPmText.value = `
          æ”¶æ¬¾å¸³è™Ÿï¼šxxxxxxx
          é‡‘é¡: ${parseFloat(apAmount.value)}
          æ³¨ï¼šé‡‘é¡ä¸è¦å°æ–¼100æ³“å¹£
        `;
            return;
        }
        apPmText.value = `
          æ”¶æ¬¾å¸³è™Ÿï¼š+852-55362770
          é‡‘é¡: ${parseFloat(apAmount.value)/10}
          æ³¨ï¼šå¯ä»¥ä¸ç”¨å¡«å€è™Ÿã€‚ä»¥åŠè¦å‚™æ³¨wbankç”¨æˆ¶åï¼Œå¦å‰‡å……å…¬é‡‘é¡ã€‚
        `;
     } else if (apPm.value == "bank-hk") {
        if (parseFloat(apAmount) < 100) {
            alert("ä½ çš„é‡‘é¡éå°");
            apPmText.value = `
          æ”¶æ¬¾å¸³è™Ÿï¼šxxxxxxx
          é‡‘é¡: ${parseFloat(apAmount.value)}
          æ³¨ï¼šé‡‘é¡ä¸è¦å°æ–¼100æ³“å¹£
        `;
            return;
        }
        apPmText.value = `
          FPSæ”¶æ¬¾å¸³è™Ÿï¼š+852-55362770
          é‡‘é¡: ${parseFloat(apAmount.value)/10}
          æ³¨ï¼šå¯ä»¥ä¸ç”¨å¡«å€è™Ÿã€‚ä»¥åŠè¦å‚™æ³¨wbankç”¨æˆ¶åï¼Œå¦å‰‡å……å…¬é‡‘é¡ã€‚
        `;
     } else {
        apPm.value = "default";
        apPmText.value = `
          ç›®å‰ä¸æ”¯æ´é€™ä»˜æ¬¾æ–¹å¼ï¼Œæ‰€ä»¥ä½ ä¸æœƒæœ‰æ”¶æ¬¾å¸³è™Ÿçš„ã€‚
        `;
        }
    };
     // End-cash-in
      document.getElementById("pp").addEventListener("click",() => {
        let amount = prompt("How much do you wanna buy in?");
        let value = amount*3.5;
        window.location.href="/wbank/v1/paypal?user="+user+"&amount="+value;
      });
        socket.on("errorMsg",(msg)=> {
         alert(msg);
      });
        window.onload = function() {
            socket.on("connect", () => {
                console.log("Connected socketIO server");
            });
            /*
            var bal = '{{ balance }}';
            socket.on("UpdateProfit", (data) => {
                // æ›´æ–° HTML å…ƒç´ 
                document.querySelector('p:first-of-type').innerHTML = `ä½ çš„ç¸½è³‡ç”¢: WTC$${data.amount} `;
            });

            if (bal > 0) {
                setInterval(() => {
                    socket.emit("trade", { username: '{{user}}', balance: bal });
                }, 1000);
            }
            */
        }
        function closeQRCode() {
        document.getElementById('qrModal').style.display = 'none'; // éš±è—æ¨¡æ…‹æ¡†
        }
        //Stock place
document.getElementById("availableStocks").innerHTML = "<center><b><h3>æŠ±æ­‰ï¼Œå› ç›£ç®¡æ‰€ä»¥åœç”¨æŠ•è³‡åŠŸèƒ½ã€‚</h3></b></center>";
function changeBGColor() {
    if (document.getElementById('colorSwitch').checked) {
          document.getElementById('container').style.backgroundColor="rgb(0,0,0)";
          document.querySelector('.card').style.backgroundColor="rgb(0,0,0)";
          document.getElementById('tradeChart').style.backgroundColor="rgb(0,0,0)";
          document.getElementById('tradeChart').style.color="rgb(255,255,255)";
          document.getElementById('availableStocks').style.backgroundColor="rgb(128,128,128)";
          document.getElementById('availableStocks').style.color="rgb(255,255,255)";
          document.querySelector('mt-5').style.color="rgb(255,255,255)";
          document.querySelector('table table-striped').style.backgroundColor="rgb(128,128,128)";
          document.querySelector('table table-striped').style.color="rgb(255,255,255)";
    } else {
        document.getElementById('container').style.backgroundColor="rgb(255,255,255)";
        document.querySelector('.card').style.backgroundColor="rgb(255,255,255)";
        document.getElementById('tradeChart').style.backgroundColor="rgb(255,255,255)";
        document.getElementById('tradeChart').style.color="rgb(0,0,0)";
        document.getElementById('availableStocks').style.backgroundColor="rgb(255,255,255)";
        document.getElementById('availableStocks').style.color="rgb(0,0,0)";
        document.querySelector('mt-5').style.color="rgb(0,0,0)";
        document.querySelector('table table-striped').style.backgroundColor="rgb(255,255,255)";
        document.querySelector('table table-striped').style.color="rgb(0,0,0)";
    }
}
let portfolio = JSON.parse(localStorage.getItem('portfolio')) || [];
const stockPrices = {
    "WBankå…§éŠ€è‚¡": 45.89,
    "æ³“åœ‹ç¶œåˆæŒ‡æ•¸": Math.floor(Math.random() * (80 - 12 + 1)) + 12,
    "ç¶“ç™¼é›†åœ˜": Math.floor(Math.random() * (55 - 20 + 1)) + 20,
    "WTC/HKD": Math.floor(Math.random() * (34000 - 1200 + 1)) + 1200,
    "BEn-stock": 0.39
};

function updateBalance() {
    document.getElementById('balance').innerText = balance.toFixed(2); // æ›´æ–°é¤˜é¡é¡¯ç¤º
}

function renderPortfolio() {
    const portfolioTable = document.getElementById('portfolio');
    portfolioTable.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å…§å®¹

    portfolio.forEach((stock) => {
        const originalPrice = stock.originalPrice || stock.price; // ä½¿ç”¨åŸå§‹åƒ¹æ ¼ä¾†è¨ˆç®—ç™¾åˆ†æ¯”
        if (stock.buyer != "{{user}}") {
            return;
        }
        const row = `<tr>
            <td>${stock.symbol}</td>
            <td class="price">${stock.price.toFixed(2)}</td>
            <td>${stock.quantity}</td>
            <td>${(stock.price * stock.quantity).toFixed(2)}</td>
            <td><button class="btn btn-danger" onclick="sellStock('${stock.symbol}')">è³£å‡º</button></td>
        </tr>`;
        
        portfolioTable.innerHTML += row; // æ·»åŠ æ¯ä¸€è¡Œçš„æ•¸æ“š
    });
}

function fetchStockPrice(stockSymbol) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${stockSymbol}`;

    return fetch(url)
        .then(response => response.json())
        .then(data => {
            if (!data.chart.result[0]) {
               alert("æœªæ‰¾åˆ°åºåˆ—æ•¸æ“š");
               throw new Error("æœªæ‰¾åˆ°æ™‚é–“åºåˆ—æ•¸æ“š");
            }
            let currentPrice = parseFloat(data.chart.result[0].meta.regularMarketPrice);
            return currentPrice;
        });
}

function randomPriceChange(stockSymbol) {
    let currentPrice = stockPrices[stockSymbol];
    currentPrice = parseFloat(currentPrice);
    const change = ((currentPrice * (1 + 0.1) - currentPrice) / currentPrice * 100 ).toFixed(1); // æ”¶å–10%æ‰‹çºŒè²»(å…¬å¼ï¼š(æ–°-èˆŠ)é™¤èˆŠ*100%)
    //const change = currentPrice*100/100;
    let newPrice = currentPrice.toFixed(2); // ç¢ºä¿åƒ¹æ ¼ä¸ä½æ–¼ 0ï¼Œå› ç‚ºåƒ¹æ ¼ä¸å¯èƒ½ç‚º0
    // let newPrice;
    // Record Time&date
    const targetTimes = [
       { hour: 9, minute: 0, second: 0 },
       { hour: 13, minute: 0, second: 0 },
       { hour: 17, minute: 30, second: 0 },
       { hour: 20, minute: 0, second: 0 },
       { hour: 22, minute: 0, second: 0 }
    ];
    const now = new Date().toLocaleString('zh-HK', { timeZone: 'Asia/Taipei' });
    const nowDate = new Date(now);
    let currentPeriod = null;

for (let i = 0; i < targetTimes.length; i++) {
    const startTime = new Date();
    startTime.setHours(targetTimes[i].hour, targetTimes[i].minute, targetTimes[i].second);

    let endTime;
    if (i < targetTimes.length - 1) {
        endTime = new Date();
        endTime.setHours(targetTimes[i + 1].hour, targetTimes[i + 1].minute, targetTimes[i + 1].second);
    } else {
        endTime = new Date(startTime);
        endTime.setDate(endTime.getDate() + 1);
    }

    if (nowDate >= startTime && nowDate < endTime) {
        currentPeriod = targetTimes[i];
        break;
    }
}
/*
if (currentPeriod) {
    if (currentPeriod.hour == 9) {
        if (stockSymbol == "WBankå…§éŠ€è‚¡") {
            newPrice += 0.01
        } else if (stockSymbol == "æ³“åœ‹ç¶œåˆæŒ‡æ•¸") {
            newPrice -= 0.02
        } else if (stockSymbol == "ç¶“ç™¼é›†åœ˜") {
            newPrice += 0.01
        } else if (stockSymbol == "WTC/HKD") {
            newPrice += 0.01
        } else if (stockSymbol == "BEn-stock") {
            newPrice += 0.04
        }
    } else if (currentPeriod.hour == 13) {
        if (stockSymbol == "WBankå…§éŠ€è‚¡") {
            newPrice -= 1.00
        } else if (stockSymbol == "æ³“åœ‹ç¶œåˆæŒ‡æ•¸") {
            newPrice += 0.02
        } else if (stockSymbol == "ç¶“ç™¼é›†åœ˜") {
            newPrice += 4.56
        } else if (stockSymbol == "WTC/HKD") {
            newPrice += 0.1
        } else if (stockSymbol == "BEn-stock") {
            newPrice += 1.00
        }
    } else if (currentPeriod.hour == 17 && currentPeriod.minute == 30) {
        if (stockSymbol == "WBankå…§éŠ€è‚¡") {
            newPrice += 0.5
        } else if (stockSymbol == "æ³“åœ‹ç¶œåˆæŒ‡æ•¸") {
            newPrice += 0.5
        } else if (stockSymbol == "ç¶“ç™¼é›†åœ˜") {
            newPrice += 80.09
        } else if (stockSymbol == "WTC/HKD") {
            newPrice += 5.00
        } else if (stockSymbol == "BEn-stock") {
            newPrice -= 0.1
        }
    } else if (currentPeriod.hour == 20) {
        if (stockSymbol == "WBankå…§éŠ€è‚¡") {
            newPrice += 0.19
        } else if (stockSymbol == "æ³“åœ‹ç¶œåˆæŒ‡æ•¸") {
            newPrice += 0.6
        } else if (stockSymbol == "ç¶“ç™¼é›†åœ˜") {
            newPrice -= 0.08
        } else if (stockSymbol == "WTC/HKD") {
            newPrice += 2.00
        } else if (stockSymbol == "BEn-stock") {
            newPrice -= 0.2
        }
    } else if (currentPeriod.hour == 22) {
        if (stockSymbol == "WBankå…§éŠ€è‚¡") {
            newPrice += 0.2
        } else if (stockSymbol == "æ³“åœ‹ç¶œåˆæŒ‡æ•¸") {
            newPrice -= 2.09
        } else if (stockSymbol == "ç¶“ç™¼é›†åœ˜") {
            newPrice -= 1.02
        } else if (stockSymbol == "WTC/HKD") {
            newPrice += 0.98
        } else if (stockSymbol == "BEn-stock") {
            newPrice -= 2.55
        }
    } else {
        newPrice += 0.03;
    }
} else {
    newPrice += 0.03;
}
*/
    stockPrices[stockSymbol] = newPrice;


    // æ›´æ–°å¯ç”¨è‚¡ç¥¨å€åŸŸ
    const rows = document.querySelectorAll('#availableStocks tr');
    let priceElement = null;
    let triangleElement = null;
    let percentageElement = null;

    for (const row of rows) {
        const symbolCell = row.querySelector('td:first-child');
        if (symbolCell && symbolCell.innerText === stockSymbol) {
            priceElement = row.querySelector('.price'); // ç²å–åƒ¹æ ¼å…ƒç´ 
            triangleElement = row.querySelector('.triangle'); // ç²å–ä¸‰è§’å½¢å…ƒç´ 
            percentageElement = row.querySelector('.percentage'); // ç²å–ç™¾åˆ†æ¯”å…ƒç´ 
            break; // æ‰¾åˆ°å¾Œé€€å‡ºå¾ªç’°
        }
    }

    if (priceElement) {
        priceElement.innerText = newPrice; // æ›´æ–°åƒ¹æ ¼
        
        // è¨ˆç®—ä¸¦é¡¯ç¤ºè®Šå‹•ç™¾åˆ†æ¯”
        const percentageChange = (parseFloat(newPrice) * change).toFixed(1);
        if (percentageElement) {
            percentageElement.innerText = `${percentageChange}%`;
        }
        
        // æ›´æ–°ä¸‰è§’å½¢é¡è‰²
        if (triangleElement) {
            if (percentageChange >= 58) {
                triangleElement.style.borderBottom = "10px solid green"; // ä¸Šå‡é¡è‰²
            } else {
                triangleElement.style.borderBottom = "10px solid red"; // ä¸‹é™é¡è‰²
            }
        }
    }

    // æ›´æ–°æŒå€‰å€åŸŸ
    const portfolioRows = document.querySelectorAll('#portfolio tr');
    for (const row of portfolioRows) {
        const symbolCell = row.querySelector('td:first-child');
        if (symbolCell && symbolCell.innerText === stockSymbol) {
            const portfolioPriceElement = row.querySelector('.price'); // ç²å–æŒå€‰ä¸­çš„åƒ¹æ ¼å…ƒç´ 
            if (portfolioPriceElement) {
                portfolioPriceElement.innerText = newPrice; // æ›´æ–°æŒå€‰åƒ¹æ ¼
            }
            break; // æ‰¾åˆ°å¾Œé€€å‡ºå¾ªç’°
        }
    }
}
        
document.addEventListener('DOMContentLoaded', function() {
    // å‡è¨­æ‚¨æœ‰å¤šå€‹æŒ‰éˆ•
    const buyButtons = document.querySelectorAll('#availableStocks button');
    buyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const stockSymbol = this.closest('tr').querySelector('td:first-child').innerText;
            buyStock(stockSymbol);
        });
    });
});
        
function buyStock(stockSymbol) {
    // æŸ¥æ‰¾æ‰€æœ‰è¡Œä¸¦æ‰¾åˆ°å°æ‡‰çš„è¡Œ
    const rows = document.querySelectorAll('#availableStocks tr');
    let priceElement = null;

    for (const row of rows) {
        const symbolCell = row.querySelector('td:first-child');
        if (symbolCell && symbolCell.innerText === stockSymbol) {
            priceElement = row.querySelector('.price'); // ç²å–åƒ¹æ ¼å…ƒç´ 
            break; // æ‰¾åˆ°å¾Œé€€å‡ºå¾ªç’°
        }
    }

    if (!priceElement) {
        console.error(`Price element for ${stockSymbol} not found.`);
        alert('ç„¡æ³•æ‰¾åˆ°è‚¡ç¥¨åƒ¹æ ¼ï¼Œè«‹æª¢æŸ¥ç¶²é çµæ§‹ã€‚');
        return;
    }

    const stockPrice = parseFloat(priceElement.innerText);
    let quantity = prompt("è«‹è¼¸å…¥è³¼è²·æ•¸é‡:");
    if (!quantity || quantity == "" || quantity == null) {
        alert("ä¸çŸ¥é“ä½ è¦è²·å¤šå°‘");
        return;
    }
    quantity = parseInt(quantity);
    const totalCost = stockPrice * quantity;

    if (totalCost > balance) {
        alert('é¤˜é¡ä¸è¶³ï¼');
        return;
    }

    alert("Ok " + stockSymbol);
    balance -= totalCost;
    let msg = "ä½ å·²æˆåŠŸè²·å…¥ " + stockSymbol + ", å…±wtc$"+totalCost.toString()+", å…±"+quantity.toString()+"æ‰‹";
    Toastify({
            text: msg, // Toast è¨Šæ¯å…§å®¹
            duration: 5000,        // é¡¯ç¤ºæ™‚é–“ (æ¯«ç§’)
            gravity: "bottom",     // Toast é¡¯ç¤ºçš„ä½ç½® (top, bottom, top-center, bottom-center, ...)
            position: 'right',     // Toast æ°´å¹³ä½ç½® (left, center, right)
            className: "info-toast", // è‡ªè¨‚ CSS class (å¯ä»¥è‡ªè¨‚æ¨£å¼)
            //backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)", // è‡ªè¨‚èƒŒæ™¯é¡è‰² (å¯é¸)
        }).showToast();
    
    updateBalance();

    fetch("/wbank/hash/transfer", {
        method: "GET",
        headers: {
            "user": user,
            "reviewer": "wbank",
            "amount": totalCost.toString() // ç¢ºä¿æ˜¯å­—ç¬¦ä¸²
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("è³¼è²·æˆåŠŸ");
            const stock = { symbol: stockSymbol, price: stockPrice, quantity: quantity, originalPrice:stockPrice, buyer: "{{user}}" };
            portfolio.push(stock);
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            renderPortfolio(); // æ›´æ–°å·²è³¼è²·è‚¡ç¥¨çš„é¡¯ç¤º
        } else {
            alert('è³¼è²·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
        }
    })
    .catch(error => {
        console.error('éŒ¯èª¤:', error);
        alert('è³¼è²·éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ã€‚');
        balance += totalCost;
    });
}
        
function sellStock(stockSymbol) {
    // æŸ¥æ‰¾æ‰€æœ‰è¡Œä¸¦æ‰¾åˆ°å°æ‡‰çš„è¡Œ
    const rows = document.querySelectorAll('#portfolio tr');
    let stock = null;

    for (const row of rows) {
        const symbolCell = row.querySelector('td:first-child');
        if (symbolCell && symbolCell.innerText === stockSymbol) {
            stock = {
                price: parseFloat(row.querySelector('td:nth-child(2)').innerText),
                quantity: parseInt(row.querySelector('td:nth-child(3)').innerText)
            };
            break; // æ‰¾åˆ°å¾Œé€€å‡ºå¾ªç’°
        }
    }

    if (!stock) {
        console.error(`Stock ${stockSymbol} not found in portfolio.`);
        alert('æœªæ‰¾åˆ°è©²è‚¡ç¥¨ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æŠ•è³‡çµ„åˆã€‚');
        return;
    }

    const totalGain = stock.price * stock.quantity;

    let msg = "ä½ å·²æˆåŠŸè³£å‡º " + stockSymbol + ", å…±wtc$"+totalGain.toString();
    Toastify({
            text: msg, // Toast è¨Šæ¯å…§å®¹
            duration: 5000,        // é¡¯ç¤ºæ™‚é–“ (æ¯«ç§’)
            gravity: "bottom",     // Toast é¡¯ç¤ºçš„ä½ç½® (top, bottom, top-center, bottom-center, ...)
            position: 'right',     // Toast æ°´å¹³ä½ç½® (left, center, right)
            className: "info-toast", // è‡ªè¨‚ CSS class (å¯ä»¥è‡ªè¨‚æ¨£å¼)
            //backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)", // è‡ªè¨‚èƒŒæ™¯é¡è‰² (å¯é¸)
        }).showToast();

    // æ›´æ–°é¤˜é¡
    balance += totalGain;
    updateBalance();

    fetch("/wbank/hash/transfer", {
        method: "GET",
        headers: {
            "user": "wbank",
            "reviewer": user,
            "amount": totalGain.toString() // ç¢ºä¿æ˜¯å­—ç¬¦ä¸²
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            portfolio = portfolio.filter(item => item.symbol !== stockSymbol); // ç§»é™¤å·²è³£å‡ºçš„è‚¡ç¥¨
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            renderPortfolio(); // æ›´æ–°å·²è³¼è²·è‚¡ç¥¨çš„é¡¯ç¤º
            alert('è³£å‡ºæˆåŠŸ');
        } else {
            alert(data["Error-hint"]);
            alert('è³£å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
        }
    })
    .catch(error => {
        console.error('éŒ¯èª¤:', error);
        alert('è³£å‡ºéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ã€‚'+error);
    });
}
   // Chat UI
   // ç²å– modal å’ŒæŒ‰éˆ•å…ƒç´ 
        const Chatmodal = document.getElementById("chatModal");
        const openModalButton = document.getElementById("open-chat-modal");
        const closeModalButton = document.getElementsByClassName("chat-close")[0];
        let chatMessages = document.getElementById('chat-messages');
        let messageInput = document.getElementById('message-input');
        let chatArea = document.querySelector('.chat-area');
        let username = user;
        let chatRoom = "å®¢æˆ¶æœå‹™--" + username + "#" + Math.floor(Math.random() * (1999 - 11 + 1)) + 11;

        // æ‰“é–‹ modal
        openModalButton.onclick = function() {
            Chatmodal.style.display = "block";
            chatArea.style.display = "block";
            socket.emit('joinChat', { username, room_number: chatRoom });
        }

        // é—œé–‰ modal
        closeModalButton.onclick = function() {
            Chatmodal.style.display = "none";
            socket.emit('leaveChat', { username, room_number: chatRoom });
        }
        const compressImage = (imageFile, maxWidth = 800) => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(imageFile);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = Math.round((height * maxWidth) / width);
                    width = maxWidth;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL(imageFile.type, 0.7); // 0.7 æ˜¯å£“ç¸®å“è³ªï¼Œå¯ä»¥èª¿æ•´
                resolve(dataUrl);
            };
        };
        reader.onerror = (error) => {
            console.error("åœ–ç‰‡è®€å–éŒ¯èª¤:", error);
            resolve(null); // ç™¼ç”ŸéŒ¯èª¤æ™‚è§£æç‚º null
        };
    });
};
        
        document.getElementById("send-button").onclick = async function() {
            const message = messageInput.value;
            const imageUpload = document.getElementById("image-upload").files[0];
            let msgType = "text";
            if (imageUpload) {
        msgType = "image";

        // é¡¯ç¤º "åœ–ç‰‡ç™¼é€ä¸­..." è¨Šæ¯ (è¦–è¦ºå›é¥‹)
        const sendingMessageElement = document.createElement('div');
        sendingMessageElement.classList.add('message', 'sent', 'sending-message'); // åŠ å…¥ 'sending-message' é¡åˆ¥æ–¹ä¾¿è­˜åˆ¥
        sendingMessageElement.innerHTML = `<div class="chat-text">åœ–ç‰‡ç™¼é€ä¸­...</div>`;
        chatMessages.appendChild(sendingMessageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight; // ç¢ºä¿è¨Šæ¯å¯è¦‹

        try {
            const compressedDataUrl = await compressImage(imageUpload); // ç­‰å¾…åœ–ç‰‡å£“ç¸®å®Œæˆ

            if (compressedDataUrl) { // æª¢æŸ¥å£“ç¸®æ˜¯å¦æˆåŠŸ
                const msgData = { username: username, imageData: compressedDataUrl, room_number: chatRoom, type: msgType, timestamp: Date.now(), mimeType: imageUpload.type };
                socket.emit('chatMessage', msgData);
                chatMessages.appendChild(createMessageElement(msgData));
                document.getElementById("image-upload").value = '';
            } else {
                // åœ–ç‰‡å£“ç¸®å¤±æ•—çš„è™•ç† (ä¾‹å¦‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯)
                alert("åœ–ç‰‡å£“ç¸®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        } catch (error) {
            console.error("åœ–ç‰‡è™•ç†éŒ¯èª¤:", error);
            alert("åœ–ç‰‡è™•ç†éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); // éŒ¯èª¤è™•ç†ï¼Œä¾‹å¦‚é¡¯ç¤º alert
        } finally {
            // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½ç§»é™¤ "åœ–ç‰‡ç™¼é€ä¸­..." è¨Šæ¯
            chatMessages.removeChild(sendingMessageElement); // ç§»é™¤è¼‰å…¥è¨Šæ¯
        }
            } else {
                const messageData = { username: username, text: message, room_number: chatRoom, type: msgType, timestamp: Date.now() };
                socket.emit('chatMessage', messageData);
                chatMessages.appendChild(createMessageElement(messageData));
                messageInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                chatMessages.scrollTop = chatMessages.scrollHeight; // æ»¾å‹•åˆ°æœ€æ–°æ¶ˆæ¯
            }
        }

        // é›¢é–‹é »é“
        document.getElementById("exit-button").onclick = function() {
            Chatmodal.style.display = "none"; // éš±è— chat-modal
            chatMessages.innetHTML = "";
            socket.emit('leaveChat', { username, room_number: chatRoom });
        }

        // å‰µå»ºè¨Šæ¯å…ƒç´ 
        const createMessageElement = (data) => {
            const message = document.createElement('div');
            message.classList.add('message');

            if (data.username === username) {
                message.classList.add('sent'); // è‡ªå·±çš„æ¶ˆæ¯
            } else {
                message.classList.add('received'); // å°æ–¹çš„æ¶ˆæ¯
            }

            const timestamp = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (data.type === 'text') {
                message.innerHTML = `<div class="username">${data.username}</div><div class="chat-text">${data.text}</div><div class="timestamp">${timestamp}</div>`;
             } else if (data.type === 'image') {
                message.innerHTML = `<div class="username">${data.username}</div><img src="${data.imageData}" alt="image" style="max-width: 90px"><div class="timestamp">${timestamp}</div>`;
             }
            return message;
        };

        // æ¥æ”¶è¨Šæ¯
        socket.on('chatMessage', (data) => {
            let msgData = {};
            msgData = data.type === "image" ?
        { username: data.username, imageData: data.imageData, type: data.type, timestamp: data.timestamp, mimeType: data.mimeType } :
        { username: data.username, text: data.text, type: data.type, timestamp: data.timestamp };
            if (data.username !== username) {
                chatMessages.appendChild(createMessageElement(msgData));
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
         });
   /*
   const reloadStockButton = () => {
     Object.keys(stockPrices).forEach(stock => randomPriceChange(stock));
   };
   */
   setInterval(()=>{
     Object.keys(stockPrices).forEach(stock => randomPriceChange(stock));
   },5000)
   updateBalance(); // åˆå§‹åŒ–é¤˜é¡
   renderPortfolio(); // æ¸²æŸ“æŠ•è³‡çµ„åˆ
    </script>
</body>
</html>
