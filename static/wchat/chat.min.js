let socket=io(),usernameInput=document.getElementById("username-input"),submitUsernameButton=document.getElementById("submit-username"),activeChannels=document.getElementById("active-channels"),channelListItems=document.getElementById("channel-list-items"),chatMessages=document.getElementById("chat-messages"),messageInput=document.getElementById("message-input"),sendButton=document.getElementById("send-button"),chatContainer=document.getElementById("chat-container"),exitButton=document.getElementById("exit-button"),timeDisplayList=document.getElementById("timeList");let username=null,room=null;function updateTime(){timeDisplayList.textContent=new Date().toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}setInterval(updateTime,1e3),updateTime();const loadChatHistory=()=>{let e=JSON.parse(sessionStorage.getItem("chatMessages"))||[];e.forEach(e=>{let t=createMessageElement(e);chatMessages.appendChild(t)}),chatMessages.scrollTop=chatMessages.scrollHeight},saveChatHistory=e=>{let t=JSON.parse(sessionStorage.getItem("chatMessages"))||[];t.push(e),sessionStorage.setItem("chatMessages",JSON.stringify(t))};submitUsernameButton.addEventListener("click",()=>{if(!(username=usernameInput.value)){alert("請輸入用戶名");return}usernameInput.style.display="none",activeChannels.style.display="block",loadActiveChannels()});const allChannels={morning:["財經群組","政府事務發洩區","wbank客服"],afternoon:["邦金國際金融","wbank客服","金融經紀Ben","閒聊區"],evening:["邦金國際金融","世遊娛樂城","VIP888荷官","馬會出糧區","波友區","wbank客服"]},getCurrentTimeSlot=()=>{let e=new Date,t=e.getHours();return(setInterval(()=>{let e=new Date;timeDisplayList.innerHTML=e.toLocaleString()},1e3),t>=6&&t<12)?"morning":t>=12&&t<18?"afternoon":"evening"},loadActiveChannels=()=>{let e=getCurrentTimeSlot(),t=allChannels[e];channelListItems.innerHTML="",t.forEach(e=>{let t=document.createElement("div");t.classList.add("channel-item"),t.textContent=e,t.addEventListener("click",()=>{room=e,socket.emit("joinChat",{username,room_number:room}),chatContainer.style.display="flex",loadChatHistory()}),channelListItems.appendChild(t)}),0===t.length&&(activeChannels.style.display="none")},createMessageElement=e=>{let t=document.createElement("div");t.classList.add("message"),e.username===username?t.classList.add("sent"):t.classList.add("received");let s=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return"text"===e.type?t.innerHTML=`<div class="username">${e.username}</div><div class="chat-text">${e.text}</div><div class="timestamp">${s}</div>`:"image"===e.type&&(t.innerHTML=`<div class="username">${e.username}</div><img src="${e.imageData}" alt="image" style="max-width: 150px"><div class="timestamp">${s}</div>`),t},compressImage=(e,t=800)=>new Promise(s=>{let a=new FileReader;a.readAsDataURL(e),a.onload=a=>{let n=new Image;n.src=a.target.result,n.onload=()=>{let a=n.width,i=n.height;a>t&&(i=Math.round(i*t/a),a=t);let l=document.createElement("canvas");l.width=a,l.height=i;let m=l.getContext("2d");m.drawImage(n,0,0,a,i);let r=l.toDataURL(e.type,.7);s(r)}},a.onerror=e=>{console.error("圖片讀取錯誤:",e),s(null)}});sendButton.addEventListener("click",async()=>{let e=messageInput.value,t=document.getElementById("image-upload").files[0],s="text";if(t){s="image";let a=document.createElement("div");a.classList.add("message","sent","sending-message"),a.innerHTML=`<div class="chat-text">圖片發送中...</div>`,chatMessages.appendChild(a),chatMessages.scrollTop=chatMessages.scrollHeight;try{let n=await compressImage(t);if(n){let i={username:username,imageData:n,room_number:room,type:s,timestamp:Date.now(),mimeType:t.type};socket.emit("chatMessage",i),chatMessages.appendChild(createMessageElement(i)),document.getElementById("image-upload").value=""}else alert("圖片壓縮失敗，請稍後再試。")}catch(l){console.error("圖片處理錯誤:",l),alert("圖片處理錯誤，請稍後再試。")}finally{chatMessages.removeChild(a)}}if(e){let m={username:username,text:e,room_number:room,type:s,timestamp:Date.now()};socket.emit("chatMessage",m),chatMessages.appendChild(createMessageElement(m)),saveChatHistory(m),messageInput.value=""}chatMessages.scrollTop=chatMessages.scrollHeight}),socket.on("chatMessage",e=>{let t={};t="image"===e.type?{username:e.username,imageData:e.imageData,type:e.type,timestamp:e.timestamp,mimeType:e.mimeType}:{username:e.username,text:e.text,type:e.type,timestamp:e.timestamp},e.username!==username&&(chatMessages.appendChild(createMessageElement(t)),saveChatHistory(t)),chatMessages.scrollTop=chatMessages.scrollHeight}),exitButton.addEventListener("click",()=>{socket.emit("leaveChat",{username,room_number:room}),chatMessages.innerHTML="",sessionStorage.removeItem("chatMessages"),chatContainer.style.display="none",usernameInput.style.display="block",activeChannels.style.display="none"});